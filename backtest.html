<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bollinger Bands Backtest</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const TrendingUp = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const TrendingDown = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
        <polyline points="17 18 23 18 23 12"></polyline>
      </svg>
    );

    const Percent = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="19" y1="5" x2="5" y2="19"></line>
        <circle cx="6.5" cy="6.5" r="2.5"></circle>
        <circle cx="17.5" cy="17.5" r="2.5"></circle>
      </svg>
    );

    const Activity = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
      </svg>
    );

    const DollarSign = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="1" x2="12" y2="23"></line>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
      </svg>
    );

    function BollingerBacktest() {
      const [coin, setCoin] = useState('BTC');
      const [data, setData] = useState(null);
      const [backtest, setBacktest] = useState(null);
      const [loading, setLoading] = useState(true);
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      // Strategy Parameters
      const [startingCapital, setStartingCapital] = useState(10000);
      const [leverage, setLeverage] = useState(10);
      const [period, setPeriod] = useState(20);
      const [stdDev, setStdDev] = useState(2.0);
      const [buyZone, setBuyZone] = useState(5);
      const [sellZone, setSellZone] = useState(5);
      const [stopLossEnabled, setStopLossEnabled] = useState(false);
      const [stopLossPercent, setStopLossPercent] = useState(20);

      const calculateBollingerBands = (prices, customPeriod, customStdDev) => {
        if (prices.length < customPeriod) return null;
        
        const recentPrices = prices.slice(-customPeriod);
        const sma = recentPrices.reduce((a, b) => a + b, 0) / customPeriod;
        
        const squaredDiffs = recentPrices.map(price => Math.pow(price - sma, 2));
        const variance = squaredDiffs.reduce((a, b) => a + b, 0) / customPeriod;
        const standardDeviation = Math.sqrt(variance);
        
        return {
          upper: sma + (standardDeviation * customStdDev),
          middle: sma,
          lower: sma - (standardDeviation * customStdDev)
        };
      };

      const getPositionInBand = (price, bands) => {
        if (!bands) return null;
        return ((price - bands.lower) / (bands.upper - bands.lower)) * 100;
      };

      const getSignal = (position, customBuyZone, customSellZone) => {
        if (position === null) return null;
        if (position <= customBuyZone) return 'BUY';
        if (position >= (100 - customSellZone)) return 'SELL';
        return null;
      };

      const runBacktest = (historicalData, params) => {
        const trades = [];
        let position = null;
        let entryPrice = 0;
        let capital = params.startingCapital;
        let totalCapital = capital;
        
        const chartData = [];
        const signals = [];
        
        for (let i = params.period; i < historicalData.length; i++) {
          const prices = historicalData.slice(0, i + 1).map(d => d.close);
          const currentPrice = prices[prices.length - 1];
          const bands = calculateBollingerBands(prices, params.period, params.stdDev);
          const positionInBand = getPositionInBand(currentPrice, bands);
          const signal = getSignal(positionInBand, params.buyZone, params.sellZone);
          
          chartData.push({
            timestamp: historicalData[i].timestamp,
            price: currentPrice,
            upper: bands.upper,
            middle: bands.middle,
            lower: bands.lower,
            positionInBand: positionInBand
          });
          
          // Check stop loss
          if (position === 'long' && params.stopLossEnabled) {
            const currentLoss = ((currentPrice - entryPrice) / entryPrice) * 100;
            if (currentLoss <= -params.stopLossPercent) {
              const pnl = ((currentPrice - entryPrice) / entryPrice) * capital * params.leverage;
              totalCapital += pnl;
              trades.push({
                type: 'long',
                entry: entryPrice,
                exit: currentPrice,
                exitReason: 'Stop Loss',
                pnl: pnl,
                pnlPercent: ((currentPrice - entryPrice) / entryPrice) * 100 * params.leverage,
                timestamp: historicalData[i].timestamp
              });
              position = null;
              capital = totalCapital;
              continue;
            }
          }
          
          if (signal === 'BUY' && position === null) {
            position = 'long';
            entryPrice = currentPrice;
            capital = totalCapital;
            signals.push({ index: i, type: 'BUY', price: currentPrice });
          } else if (signal === 'SELL' && position === 'long') {
            const pnl = ((currentPrice - entryPrice) / entryPrice) * capital * params.leverage;
            totalCapital += pnl;
            trades.push({
              type: 'long',
              entry: entryPrice,
              exit: currentPrice,
              exitReason: 'Signal',
              pnl: pnl,
              pnlPercent: ((currentPrice - entryPrice) / entryPrice) * 100 * params.leverage,
              timestamp: historicalData[i].timestamp
            });
            position = null;
            capital = totalCapital;
            signals.push({ index: i, type: 'SELL', price: currentPrice });
          }
        }
        
        const winningTrades = trades.filter(t => t.pnl > 0);
        const losingTrades = trades.filter(t => t.pnl < 0);
        const winRate = trades.length > 0 ? (winningTrades.length / trades.length) * 100 : 0;
        const totalReturn = ((totalCapital - params.startingCapital) / params.startingCapital) * 100;
        const avgWin = winningTrades.length > 0 ? winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length : 0;
        const avgLoss = losingTrades.length > 0 ? losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length : 0;
        
        return {
          trades,
          chartData,
          signals,
          metrics: {
            totalTrades: trades.length,
            winningTrades: winningTrades.length,
            losingTrades: losingTrades.length,
            winRate,
            totalReturn,
            finalCapital: totalCapital,
            avgWin,
            avgLoss
          }
        };
      };

      useEffect(() => {
        const fetchData = async () => {
          setLoading(true);
          try {
            const response = await fetch(`https://bollingerboy.netlify.app/.netlify/functions/crypto-data?symbol=${coin}`);
            const binanceData = await response.json();
            
            const historicalData = binanceData.map(candle => ({
              timestamp: new Date(candle[0]),
              close: parseFloat(candle[4])
            }));
            
            setData(historicalData);
          } catch (error) {
            console.error('Error fetching data:', error);
          } finally {
            setLoading(false);
          }
        };
        
        fetchData();
      }, [coin]);

      useEffect(() => {
        if (!data) return;
        
        const params = {
          startingCapital,
          leverage,
          period,
          stdDev,
          buyZone,
          sellZone,
          stopLossEnabled,
          stopLossPercent
        };
        
        const backtestResults = runBacktest(data, params);
        setBacktest(backtestResults);
      }, [data, startingCapital, leverage, period, stdDev, buyZone, sellZone, stopLossEnabled, stopLossPercent]);

      useEffect(() => {
        if (!backtest || !chartRef.current) return;

        if (chartInstance.current) {
          chartInstance.current.destroy();
        }

        const ctx = chartRef.current.getContext('2d');
        const displayData = backtest.chartData.slice(-200);

        const buySignals = backtest.signals
          .filter(s => s.type === 'BUY')
          .filter(s => s.index >= backtest.chartData.length - 200)
          .map(s => ({
            x: displayData.findIndex(d => d.timestamp.getTime() === data[s.index].timestamp.getTime()),
            y: s.price
          }));

        const sellSignals = backtest.signals
          .filter(s => s.type === 'SELL')
          .filter(s => s.index >= backtest.chartData.length - 200)
          .map(s => ({
            x: displayData.findIndex(d => d.timestamp.getTime() === data[s.index].timestamp.getTime()),
            y: s.price
          }));

        chartInstance.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: displayData.map((d, i) => i),
            datasets: [
              {
                label: 'Price',
                data: displayData.map(d => d.price),
                borderColor: '#FFFFFF',
                backgroundColor: 'transparent',
                borderWidth: 2,
                pointRadius: 0,
                order: 2
              },
              {
                label: 'Upper Band',
                data: displayData.map(d => d.upper),
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: '+1',
                borderWidth: 1,
                borderDash: [5, 5],
                pointRadius: 0,
                order: 3
              },
              {
                label: 'Middle Band',
                data: displayData.map(d => d.middle),
                borderColor: '#3B82F6',
                backgroundColor: 'transparent',
                borderWidth: 1,
                pointRadius: 0,
                order: 4
              },
              {
                label: 'Lower Band',
                data: displayData.map(d => d.lower),
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: 'origin',
                borderWidth: 1,
                borderDash: [5, 5],
                pointRadius: 0,
                order: 5
              },
              {
                label: 'BUY Signals',
                data: buySignals,
                type: 'scatter',
                backgroundColor: '#10B981',
                borderColor: '#FFFFFF',
                borderWidth: 2,
                pointRadius: 8,
                pointHoverRadius: 10,
                order: 1
              },
              {
                label: 'SELL Signals',
                data: sellSignals,
                type: 'scatter',
                backgroundColor: '#EF4444',
                borderColor: '#FFFFFF',
                borderWidth: 2,
                pointRadius: 8,
                pointHoverRadius: 10,
                order: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: '#9CA3AF'
                }
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    const index = context[0].dataIndex;
                    return displayData[index]?.timestamp.toLocaleString() || '';
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  color: '#9CA3AF',
                  maxTicksLimit: 10
                },
                grid: {
                  color: '#374151'
                }
              },
              y: {
                ticks: {
                  color: '#9CA3AF'
                },
                grid: {
                  color: '#374151'
                }
              }
            }
          }
        });

        return () => {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
        };
      }, [backtest, data]);

      if (loading) {
        return (
          <div className="min-h-screen bg-gray-900 text-white p-8 flex items-center justify-center">
            <div className="text-center">
              <Activity />
              <p className="text-xl mt-4">Loading data...</p>
            </div>
          </div>
        );
      }

      if (!backtest) {
        return <div className="min-h-screen bg-gray-900 text-white p-8 flex items-center justify-center">
          <p>Error loading data</p>
        </div>;
      }

      const { metrics, trades } = backtest;

      return (
        <div className="min-h-screen bg-gray-900 text-white p-8">
          <div className="max-w-7xl mx-auto">
            <div className="mb-8">
              <h1 className="text-4xl font-bold mb-4">📊 Bollinger Bands Backtest</h1>
              <p className="text-gray-400">Interactive historical performance analysis</p>
              
              <div className="flex gap-4 mt-6">
                {['BTC', 'ETH', 'SOL', 'ZEC'].map(c => (
                  <button
                    key={c}
                    onClick={() => setCoin(c)}
                    className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                      coin === c
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                    }`}
                  >
                    {c}
                  </button>
                ))}
              </div>
            </div>

            {/* Settings Panel */}
            <div className="bg-gray-800 p-6 rounded-xl mb-8 border-2 border-blue-500">
              <h2 className="text-2xl font-bold mb-6">⚙️ Strategy Settings</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Starting Capital */}
                <div>
                  <label className="block text-gray-400 mb-2">Starting Capital</label>
                  <input
                    type="number"
                    value={startingCapital}
                    onChange={(e) => setStartingCapital(Number(e.target.value))}
                    className="w-full bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none"
                    placeholder="10000"
                  />
                </div>

                {/* Leverage */}
                <div>
                  <label className="block text-gray-400 mb-2">Leverage</label>
                  <div className="flex gap-2">
                    {[5, 10, 20, 40].map(lev => (
                      <button
                        key={lev}
                        onClick={() => setLeverage(lev)}
                        className={`flex-1 px-4 py-2 rounded-lg font-semibold transition-all ${
                          leverage === lev
                            ? 'bg-blue-600 text-white'
                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                        }`}
                      >
                        {lev}x
                      </button>
                    ))}
                  </div>
                </div>

                {/* Period */}
                <div>
                  <label className="block text-gray-400 mb-2">Period: {period}</label>
                  <input
                    type="range"
                    min="10"
                    max="30"
                    step="5"
                    value={period}
                    onChange={(e) => setPeriod(Number(e.target.value))}
                    className="w-full"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>10</span>
                    <span>15</span>
                    <span>20</span>
                    <span>25</span>
                    <span>30</span>
                  </div>
                </div>

                {/* Std Dev */}
                <div>
                  <label className="block text-gray-400 mb-2">Std Dev: {stdDev.toFixed(1)}</label>
                  <input
                    type="range"
                    min="1.5"
                    max="3.0"
                    step="0.5"
                    value={stdDev}
                    onChange={(e) => setStdDev(Number(e.target.value))}
                    className="w-full"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>1.5</span>
                    <span>2.0</span>
                    <span>2.5</span>
                    <span>3.0</span>
                  </div>
                </div>

                {/* Buy Zone */}
                <div>
                  <label className="block text-gray-400 mb-2">Buy Zone (0-{buyZone}%)</label>
                  <input
                    type="range"
                    min="3"
                    max="10"
                    step="1"
                    value={buyZone}
                    onChange={(e) => setBuyZone(Number(e.target.value))}
                    className="w-full"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>3%</span>
                    <span>5%</span>
                    <span>10%</span>
                  </div>
                </div>

                {/* Sell Zone */}
                <div>
                  <label className="block text-gray-400 mb-2">Sell Zone ({100-sellZone}-100%)</label>
                  <input
                    type="range"
                    min="3"
                    max="10"
                    step="1"
                    value={sellZone}
                    onChange={(e) => setSellZone(Number(e.target.value))}
                    className="w-full"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>90%</span>
                    <span>95%</span>
                    <span>97%</span>
                  </div>
                </div>

                {/* Stop Loss */}
                <div className="md:col-span-2">
                  <label className="flex items-center text-gray-400 mb-2">
                    <input
                      type="checkbox"
                      checked={stopLossEnabled}
                      onChange={(e) => setStopLossEnabled(e.target.checked)}
                      className="mr-2 w-5 h-5"
                    />
                    Enable Stop Loss
                  </label>
                  {stopLossEnabled && (
                    <div className="mt-4">
                      <label className="block text-gray-400 mb-2">Stop Loss: -{stopLossPercent}%</label>
                      <div className="flex gap-2">
                        {[10, 15, 20, 30].map(sl => (
                          <button
                            key={sl}
                            onClick={() => setStopLossPercent(sl)}
                            className={`flex-1 px-4 py-2 rounded-lg font-semibold transition-all ${
                              stopLossPercent === sl
                                ? 'bg-red-600 text-white'
                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            }`}
                          >
                            -{sl}%
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Metrics Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div className={`p-6 rounded-xl ${metrics.totalReturn >= 0 ? 'bg-green-900/30 border-2 border-green-500' : 'bg-red-900/30 border-2 border-red-500'}`}>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-gray-400">Total Return</span>
                  {metrics.totalReturn >= 0 ? <TrendingUp /> : <TrendingDown />}
                </div>
                <div className={`text-3xl font-bold ${metrics.totalReturn >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                  {metrics.totalReturn >= 0 ? '+' : ''}{metrics.totalReturn.toFixed(2)}%
                </div>
                <div className="text-sm text-gray-400 mt-2">
                  ${metrics.finalCapital.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </div>
              </div>

              <div className="bg-gray-800 p-6 rounded-xl border-2 border-gray-700">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-gray-400">Win Rate</span>
                  <Percent />
                </div>
                <div className="text-3xl font-bold text-blue-500">
                  {metrics.winRate.toFixed(1)}%
                </div>
                <div className="text-sm text-gray-400 mt-2">
                  {metrics.winningTrades}W / {metrics.losingTrades}L
                </div>
              </div>

              <div className="bg-gray-800 p-6 rounded-xl border-2 border-gray-700">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-gray-400">Total Trades</span>
                  <Activity />
                </div>
                <div className="text-3xl font-bold text-purple-500">
                  {metrics.totalTrades}
                </div>
                <div className="text-sm text-gray-400 mt-2">
                  Over {Math.round(data.length / 24)} days
                </div>
              </div>

              <div className="bg-gray-800 p-6 rounded-xl border-2 border-gray-700">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-gray-400">Avg Win/Loss</span>
                  <DollarSign />
                </div>
                <div className="text-xl font-bold text-green-500">
                  +${metrics.avgWin.toFixed(0)}
                </div>
                <div className="text-xl font-bold text-red-500">
                  ${metrics.avgLoss.toFixed(0)}
                </div>
              </div>
            </div>

            {/* Chart */}
            <div className="bg-gray-800 p-6 rounded-xl mb-8">
              <h2 className="text-2xl font-bold mb-6">Price & Signals (Last 200 Hours)</h2>
              <div style={{ height: '500px' }}>
                <canvas ref={chartRef}></canvas>
              </div>
            </div>

            {/* Trade History */}
            <div className="bg-gray-800 p-6 rounded-xl">
              <h2 className="text-2xl font-bold mb-6">Recent Trades (Last 10)</h2>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="border-b border-gray-700">
                      <th className="text-left p-3 text-gray-400">Date</th>
                      <th className="text-left p-3 text-gray-400">Type</th>
                      <th className="text-right p-3 text-gray-400">Entry</th>
                      <th className="text-right p-3 text-gray-400">Exit</th>
                      <th className="text-left p-3 text-gray-400">Exit Reason</th>
                      <th className="text-right p-3 text-gray-400">P&L</th>
                      <th className="text-right p-3 text-gray-400">Return</th>
                    </tr>
                  </thead>
                  <tbody>
                    {trades.slice(-10).reverse().map((trade, idx) => (
                      <tr key={idx} className="border-b border-gray-700/50">
                        <td className="p-3 text-gray-300">{trade.timestamp.toLocaleDateString()}</td>
                        <td className="p-3">
                          <span className="px-3 py-1 rounded-full text-sm font-semibold bg-green-900 text-green-300">
                            LONG
                          </span>
                        </td>
                        <td className="p-3 text-right text-gray-300">${trade.entry.toLocaleString()}</td>
                        <td className="p-3 text-right text-gray-300">${trade.exit.toLocaleString()}</td>
                        <td className="p-3 text-gray-300">
                          <span className={`text-xs ${trade.exitReason === 'Stop Loss' ? 'text-red-400' : 'text-blue-400'}`}>
                            {trade.exitReason}
                          </span>
                        </td>
                        <td className={`p-3 text-right font-bold ${trade.pnl >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                          {trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}
                        </td>
                        <td className={`p-3 text-right font-bold ${trade.pnlPercent >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                          {trade.pnlPercent >= 0 ? '+' : ''}{trade.pnlPercent.toFixed(2)}%
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BollingerBacktest />);
  </script>
</body>
</html>
